#!/bin/bash

declare -x MARIADB_DEFAULT_CHARACTER_SET
declare -x MARIADB_CHARACTER_SET_SERVER
declare -x MARIADB_COLLATION_SERVER
declare -x MARIADB_KEY_BUFFER_SIZE
declare -x MARIADB_MAX_ALLOWED_PACKET
declare -x MARIADB_TABLE_OPEN_CACHE
declare -x MARIADB_SORT_BUFFER_SIZE
declare -x MARIADB_NET_BUFFER_SIZE
declare -x MARIADB_READ_BUFFER_SIZE
declare -x MARIADB_READ_RND_BUFFER_SIZE
declare -x MARIADB_MYISAM_SORT_BUFFER_SIZE
declare -x MARIADB_LOG_BIN
declare -x MARIADB_BINLOG_FORMAT
declare -x MARIADB_SERVER_ID
declare -x MARIADB_INNODB_DATA_FILE_PATH
declare -x MARIADB_INNODB_BUFFER_POOL_SIZE
declare -x MARIADB_INNODB_LOG_FILE_SIZE
declare -x MARIADB_INNODB_LOG_BUFFER_SIZE
declare -x MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT
declare -x MARIADB_INNODB_LOCK_WAIT_TIMEOUT
declare -x MARIADB_INNODB_USE_NATIVE_AIO
declare -x MARIADB_MAX_ALLOWED_PACKET
declare -x MARIADB_KEY_BUFFER_SIZE
declare -x MARIADB_SORT_BUFFER_SIZE
declare -x MARIADB_READ_BUFFER
declare -x MARIADB_WRITE_BUFFER
declare -x MARIADB_DEFAULT_USER_REQUIRE_SSL
declare -x MARIADB_DEFALT_USER_SSL_SUBJECT
declare -x MARIADB_DEFAULT_USER_SSL_ISSUER
declare -x MARIADB_DEFAULT_USER_SSL_CIPHER
declare -x MARIADB_DEFAULT_USER_GLOBAL_PRIVILEGES

[[ -z "${MARIADB_DEFAULT_CHARACTER_SET}" ]] && MARIADB_DEFAULT_CHARACTER_SET="utf8"
[[ -z "${MARIADB_CHARACTER_SET_SERVER}" ]] && MARIADB_CHARACTER_SET_SERVER="utf8"
[[ -z "${MARIADB_COLLATION_SERVER}" ]] && MARIADB_COLLATION_SERVER="utf8_general_ci"
[[ -z "${MARIADB_KEY_BUFFER_SIZE}" ]] && MARIADB_KEY_BUFFER_SIZE="16M"
[[ -z "${MARIADB_MAX_ALLOWED_PACKET}" ]] && MARIADB_MAX_ALLOWED_PACKET="1M"
[[ -z "${MARIADB_TABLE_OPEN_CACHE}" ]] && MARIADB_TABLE_OPEN_CACHE="64"
[[ -z "${MARIADB_SORT_BUFFER_SIZE}" ]] && MARIADB_SORT_BUFFER_SIZE="512K"
[[ -z "${MARIADB_NET_BUFFER_SIZE}" ]] && MARIADB_NET_BUFFER_SIZE="8K"
[[ -z "${MARIADB_READ_BUFFER_SIZE}" ]] && MARIADB_READ_BUFFER_SIZE="256K"
[[ -z "${MARIADB_READ_RND_BUFFER_SIZE}" ]] && MARIADB_READ_RND_BUFFER_SIZE="512K"
[[ -z "${MARIADB_MYISAM_SORT_BUFFER_SIZE}" ]] && MARIADB_MYISAM_SORT_BUFFER_SIZE="8M"
[[ -z "${MARIADB_LOG_BIN}" ]] && MARIADB_LOG_BIN="mysql-bin"
[[ -z "${MARIADB_BINLOG_FORMAT}" ]] && MARIADB_BINLOG_FORMAT="mixed"
[[ -z "${MARIADB_SERVER_ID}" ]] && MARIADB_SERVER_ID="1"
[[ -z "${MARIADB_INNODB_DATA_FILE_PATH}" ]] && MARIADB_INNODB_DATA_FILE_PATH="ibdata1:10M:autoextend"
[[ -z "${MARIADB_INNODB_BUFFER_POOL_SIZE}" ]] && MARIADB_INNODB_BUFFER_POOL_SIZE="16M"
[[ -z "${MARIADB_INNODB_LOG_FILE_SIZE}" ]] && MARIADB_INNODB_LOG_FILE_SIZE="5M"
[[ -z "${MARIADB_INNODB_LOG_BUFFER_SIZE}" ]] && MARIADB_INNODB_LOG_BUFFER_SIZE="8M"
[[ -z "${MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT}" ]] && MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT="1"
[[ -z "${MARIADB_INNODB_LOCK_WAIT_TIMEOUT}" ]] && MARIADB_INNODB_LOCK_WAIT_TIMEOUT="50"
[[ -z "${MARIADB_INNODB_USE_NATIVE_AIO}" ]] && MARIADB_INNODB_USE_NATIVE_AIO="1"
[[ -z "${MARIADB_MAX_ALLOWED_PACKET}" ]] && MARIADB_MAX_ALLOWED_PACKET="16M"
[[ -z "${MARIADB_KEY_BUFFER_SIZE}" ]] && MARIADB_KEY_BUFFER_SIZE="20M"
[[ -z "${MARIADB_SORT_BUFFER_SIZE}" ]] && MARIADB_SORT_BUFFER_SIZE="20M"
[[ -z "${MARIADB_READ_BUFFER}" ]] && MARIADB_READ_BUFFER="2M"
[[ -z "${MARIADB_WRITE_BUFFER}" ]] && MARIADB_WRITE_BUFFER="2M"

# no sensible defaults for SSL params, these lines are noops
[[ -z "${MARIADB_DEFAULT_USER_REQUIRE_SSL}" ]] && MARIADB_DEFAULT_USER_REQUIRE_SSL=""
[[ -z "${MARIADB_DEFAULT_USER_SSL_SUBJECT}" ]] && MARIADB_DEFAULT_USER_SSL_SUBJECT=""
[[ -z "${MARIADB_DEFAULT_USER_SSL_ISSUER}" ]] && MARIADB_DEFAULT_USER_SSL_ISSUER=""
[[ -z "${MARIADB_DEFAULT_USER_SSL_CIPHER}" ]] && MARIADB_DEFAULT_USER_SSL_CIPHER=""
# end of SSL params

# the default user's privileges on *.* (global) are 'USAGE'
[[ -z "${MARIADB_DEFAULT_USER_GLOBAL_PRIVILEGES}" ]] && MARIADB_DEFAULT_USER_GLOBAL_PRIVILEGES="USAGE"
# end of privileges

/usr/bin/templater -d -p mariadb \
  -o /etc/mysql/my.cnf \
  /etc/templates/my.cnf.tmpl

if [[ $? -ne 0 ]]
then
  /bin/s6-svscanctl -t /etc/s6
fi

chown -R mysql:mysql \
  /var/lib/mysql
